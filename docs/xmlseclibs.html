<!DOCTYPE html>

<html>
<head>
  <title>xmlseclibs.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="layout.css" />
  <style>
    /*--------------------- Layout and Typography ----------------------------*/
body { font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif; font-size: 15px; line-height: 22px; color: #252519; margin: 0; padding: 0;
}
a { color: #261a3b;
} a:visited { color: #261a3b; }
p { margin: 0 0 15px 0;
}
h1, h2, h3, h4, h5, h6 { margin: 40px 0 15px 0;
} h3, h4, h5, h6 { margin-top: 20px; }
#container { position: relative;
}
#background { position: fixed; top: 0; left: 575px; right: 0; bottom: 0; background: #f5f5ff; border-left: 1px solid #e5e5ee; z-index: -1;
}
#jump_to, #jump_page { background: white; -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777; -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px; font: 10px Arial; text-transform: uppercase; cursor: pointer; text-align: right;
}
#jump_to, #jump_wrapper { position: fixed; right: 0; top: 0; padding: 5px 10px;
} #jump_wrapper { padding: 0; display: none; } #jump_to:hover #jump_wrapper { display: block; } #jump_page { padding: 5px 0 3px; margin: 0 0 25px 25px; overflow:hidden; } #jump_page .source { display: block; padding: 5px 10px; text-decoration: none; border-top: 1px solid #eee; float:left; min-width:180px; text-align:left; text-transform:none; font-size:11px; } #jump_page .source:hover { background: #f5f5ff; } #jump_page .source:first-child { }
table td { border: 0; outline: 0;
} td.docs, th.docs { max-width: 450px; min-width: 450px; min-height: 5px; padding: 10px 25px 1px 50px; overflow-x: hidden; vertical-align: top; text-align: left; } .docs pre { margin: 15px 0 15px; padding-left: 15px; } .docs p tt, .docs p code { background: #f8f8ff; border: 1px solid #dedede; font-size: 12px; padding: 0 0.2em; } .pilwrap { position: relative; } .pilcrow { font: 12px Arial; text-decoration: none; color: #454545; position: absolute; top: 3px; left: -20px; padding: 1px 2px; opacity: 0; -webkit-transition: opacity 0.2s linear; } td.docs:hover .pilcrow { opacity: 1; } td.code, th.code { padding: 14px 15px 16px 25px; width: 100%; vertical-align: top; background: #f5f5ff; border-left: 1px solid #e5e5ee; } pre, tt, code { font-size: 12px; line-height: 18px; font-family: Monaco, Consolas, "Lucida Console", monospace; margin: 0; padding: 0; } /*---------------------- Syntax Highlighting -----------------------------*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
body .hll { background-color: #ffffcc }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #954121 } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #808080 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0040D0 } /* Generic.Traceback */
body .kc { color: #954121 } /* Keyword.Constant */
body .kd { color: #954121; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #954121; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #954121 } /* Keyword.Pseudo */
body .kr { color: #954121; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #219161 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #954121 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #954121; font-weight: bold } /* Name.Tag */
body .nv { color: #19469D } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #219161 } /* Literal.String.Backtick */
body .sc { color: #219161 } /* Literal.String.Char */
body .sd { color: #219161; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #219161 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #219161 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #954121 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #219161 } /* Literal.String.Single */
body .ss { color: #19469D } /* Literal.String.Symbol */
body .bp { color: #954121 } /* Name.Builtin.Pseudo */
body .vc { color: #19469D } /* Name.Variable.Class */
body .vg { color: #19469D } /* Name.Variable.Global */
body .vi { color: #19469D } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */ /********** PHP Comment Additions ********/
td.docs .docparam {color:#DB251A;font-weight:bold;}
  </style>
</head>
<body>
  <div id="container">
    <div id="background"></div>
          <div id="jump_to">
        Jump To &hellip;
        <div id="jump_wrapper">
          <div id="jump_page">
                                          <a class="source" href="./soap-SubSearch.html">
                              soap-SubSearch.php              </a>
                                          <a class="source" href="./JWT.html">
                              JWT.php              </a>
<<<<<<< HEAD
                                          <a class="source" href="./config.html">
                              config.php              </a>
=======
>>>>>>> Added new comments and Documentation
                                          <a class="source" href="./soap-SubUpdate.html">
                              soap-SubUpdate.php              </a>
                                          <a class="source" href="./FuelAPI-Platform.html">
                              FuelAPI-Platform.php              </a>
                                          <a class="source" href="./FuelAPIHelper.html">
                              FuelAPIHelper.php              </a>
                                          <a class="source" href="./index.html">
                              index.php              </a>
                                          <a class="source" href="./xmlseclibs.html">
                              xmlseclibs.php              </a>
                                          <a class="source" href="./logout.html">
                              logout.php              </a>
                                          <a class="source" href="./exacttarget_soap_client.html">
                              exacttarget_soap_client.php              </a>
                                          <a class="source" href="./soap-wsse.html">
                              soap-wsse.php              </a>
                                          <a class="source" href="./soap-SubDetails.html">
                              soap-SubDetails.php              </a>
                                          <a class="source" href="./login.html">
                              login.php              </a>
                      </div>
        </div>
      </div>
        <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              xmlseclibs.php            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
                  <tr id="section-0">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-0">&#182;</a>
              </div>
              <p>xmlseclibs.php</p>

<p>Copyright (c) 2007-2010, Robert Richards <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#111;&#x3a;&#x72;&#114;&#x69;&#x63;&#104;&#97;&#x72;&#100;&#115;&#x40;&#x63;&#100;&#x61;&#x74;&#97;&#122;&#x6f;&#110;&#101;&#x2e;&#x6f;&#114;&#x67;">&#x72;&#114;&#x69;&#x63;&#104;&#97;&#x72;&#100;&#115;&#x40;&#x63;&#100;&#x61;&#x74;&#97;&#122;&#x6f;&#110;&#101;&#x2e;&#x6f;&#114;&#x67;</a>.
 All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
 modification, are permitted provided that the following conditions
 are met:</p>

<ul>
<li><p>Redistributions of source code must retain the above copyright
 notice, this list of conditions and the following disclaimer.</p></li>
<li><p>Redistributions in binary form must reproduce the above copyright
 notice, this list of conditions and the following disclaimer in
 the documentation and/or other materials provided with the
 distribution.</p></li>
<li><p>Neither the name of Robert Richards nor the names of his
 contributors may be used to endorse or promote products derived
 from this software without specific prior written permission.</p>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.</p></li>
</ul>

<p><em class='docparam'>@author</em>     Robert Richards <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#111;&#x3a;&#x72;&#114;&#x69;&#x63;&#104;&#97;&#x72;&#100;&#115;&#x40;&#x63;&#100;&#x61;&#x74;&#97;&#122;&#x6f;&#110;&#101;&#x2e;&#x6f;&#114;&#x67;">&#x72;&#114;&#x69;&#x63;&#104;&#97;&#x72;&#100;&#115;&#x40;&#x63;&#100;&#x61;&#x74;&#97;&#122;&#x6f;&#110;&#101;&#x2e;&#x6f;&#114;&#x67;</a>
<em class='docparam'>@copyright</em>  2007-2011 Robert Richards <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#111;&#x3a;&#x72;&#114;&#x69;&#x63;&#104;&#97;&#x72;&#100;&#115;&#x40;&#x63;&#100;&#x61;&#x74;&#97;&#122;&#x6f;&#110;&#101;&#x2e;&#x6f;&#114;&#x67;">&#x72;&#114;&#x69;&#x63;&#104;&#97;&#x72;&#100;&#115;&#x40;&#x63;&#100;&#x61;&#x74;&#97;&#122;&#x6f;&#110;&#101;&#x2e;&#x6f;&#114;&#x67;</a>
<em class='docparam'>@license</em>    http:www.opensource.org/licenses/bsd-license.php  BSD License
<em class='docparam'>@version</em>    1.3.0</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-1">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Functions to generate simple cases of Exclusive Canonical XML - Callable function is C14NGeneral()
i.e.: $canonical = C14NGeneral($domelement, TRUE);</p>
            </td>
            <td class="code">
              <div class="highlight"><pre></pre></div>            </td>
          </tr>
                  <tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>helper function </p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">function</span> <span class="nf">sortAndAddAttrs</span><span class="p">(</span><span class="nv">$element</span><span class="p">,</span> <span class="nv">$arAtts</span><span class="p">)</span> <span class="p">{</span>
   <span class="nv">$newAtts</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
   <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arAtts</span> <span class="k">AS</span> <span class="nv">$attnode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$newAtts</span><span class="p">[</span><span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">nodeName</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$attnode</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nb">ksort</span><span class="p">(</span><span class="nv">$newAtts</span><span class="p">);</span>
   <span class="k">foreach</span> <span class="p">(</span><span class="nv">$newAtts</span> <span class="k">as</span> <span class="nv">$attnode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">nodeName</span><span class="p">,</span> <span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">nodeValue</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-3">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>helper function </p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">function</span> <span class="nf">canonical</span><span class="p">(</span><span class="nv">$tree</span><span class="p">,</span> <span class="nv">$element</span><span class="p">,</span> <span class="nv">$withcomments</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$tree</span><span class="o">-&gt;</span><span class="na">nodeType</span> <span class="o">!=</span> <span class="nx">XML_DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$dom</span> <span class="o">=</span> <span class="nv">$tree</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$dom</span> <span class="o">=</span> <span class="nv">$tree</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">nodeType</span> <span class="o">!=</span> <span class="nx">XML_ELEMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">nodeType</span> <span class="o">==</span> <span class="nx">XML_DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">childNodes</span> <span class="k">AS</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">canonical</span><span class="p">(</span><span class="nv">$dom</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$withcomments</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">nodeType</span> <span class="o">==</span> <span class="nx">XML_COMMENT_NODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$withcomments</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$tree</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$dom</span><span class="o">-&gt;</span><span class="na">importNode</span><span class="p">(</span><span class="nv">$element</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$arNS</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">namespaceURI</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">prefix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$elCopy</span> <span class="o">=</span> <span class="nv">$dom</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">,</span> <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">nodeName</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$prefix</span> <span class="o">=</span> <span class="nv">$tree</span><span class="o">-&gt;</span><span class="na">lookupPrefix</span><span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$prefix</span> <span class="o">==</span> <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$elCopy</span> <span class="o">=</span> <span class="nv">$dom</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">,</span> <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">nodeName</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$elCopy</span> <span class="o">=</span> <span class="nv">$dom</span><span class="o">-&gt;</span><span class="na">createElement</span><span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">nodeName</span><span class="p">);</span>
                <span class="nv">$arNS</span><span class="p">[</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$elCopy</span> <span class="o">=</span> <span class="nv">$dom</span><span class="o">-&gt;</span><span class="na">createElement</span><span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">nodeName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$tree</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$elCopy</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-4">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create DOMXPath based on original document </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="nv">$xPath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-5">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Get namespaced attributes </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="nv">$arAtts</span> <span class="o">=</span> <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">&#39;attribute::*[namespace-uri(.) != &quot;&quot;]&#39;</span><span class="p">,</span> <span class="nv">$element</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-6">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Create an array with namespace URIs as keys, and sort them </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arAtts</span> <span class="k">AS</span> <span class="nv">$attnode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">,</span> <span class="nv">$arNS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="nv">$arNS</span><span class="p">[</span><span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$prefix</span> <span class="o">=</span> <span class="nv">$tree</span><span class="o">-&gt;</span><span class="na">lookupPrefix</span><span class="p">(</span><span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$prefix</span> <span class="o">!=</span> <span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">)</span> <span class="p">{</span>
           <span class="nv">$arNS</span><span class="p">[</span><span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$arNS</span><span class="p">[</span><span class="nv">$attnode</span><span class="o">-&gt;</span><span class="na">namespaceURI</span><span class="p">]</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$arNS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">asort</span><span class="p">(</span><span class="nv">$arNS</span><span class="p">);</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-7">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Add namespace nodes </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arNS</span> <span class="k">AS</span> <span class="nv">$namespaceURI</span><span class="o">=&gt;</span><span class="nv">$prefix</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$prefix</span> <span class="o">!=</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
              <span class="nv">$elCopy</span><span class="o">-&gt;</span><span class="na">setAttributeNS</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/2000/xmlns/&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;xmlns:&quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="p">,</span> <span class="nv">$namespaceURI</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$arNS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">ksort</span><span class="p">(</span><span class="nv">$arNS</span><span class="p">);</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-8">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Get attributes not in a namespace, and then sort and add them </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="nv">$arAtts</span> <span class="o">=</span> <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">&#39;attribute::*[namespace-uri(.) = &quot;&quot;]&#39;</span><span class="p">,</span> <span class="nv">$element</span><span class="p">);</span>
    <span class="nx">sortAndAddAttrs</span><span class="p">(</span><span class="nv">$elCopy</span><span class="p">,</span> <span class="nv">$arAtts</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-9">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Loop through the URIs, and then sort and add attributes within that namespace </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arNS</span> <span class="k">as</span> <span class="nv">$nsURI</span><span class="o">=&gt;</span><span class="nv">$prefix</span><span class="p">)</span> <span class="p">{</span>
       <span class="nv">$arAtts</span> <span class="o">=</span> <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">&#39;attribute::*[namespace-uri(.) = &quot;&#39;</span><span class="o">.</span><span class="nv">$nsURI</span><span class="o">.</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">,</span> <span class="nv">$element</span><span class="p">);</span>
       <span class="nx">sortAndAddAttrs</span><span class="p">(</span><span class="nv">$elCopy</span><span class="p">,</span> <span class="nv">$arAtts</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$element</span><span class="o">-&gt;</span><span class="na">childNodes</span> <span class="k">AS</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">canonical</span><span class="p">(</span><span class="nv">$elCopy</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$withcomments</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-10">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>$element - DOMElement for which to produce the canonical version of
$exclusive - boolean to indicate exclusive canonicalization (must pass TRUE)
$withcomments - boolean indicating wether or not to include comments in canonicalized form</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">function</span> <span class="nf">C14NGeneral</span><span class="p">(</span><span class="nv">$element</span><span class="p">,</span> <span class="nv">$exclusive</span><span class="o">=</span><span class="k">FALSE</span><span class="p">,</span> <span class="nv">$withcomments</span><span class="o">=</span><span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-11">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>IF PHP 5.2+ then use built in canonical functionality </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="nv">$php_version</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="k">PHP_VERSION</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="nv">$php_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$php_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="nv">$php_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">C14N</span><span class="p">(</span><span class="nv">$exclusive</span><span class="p">,</span> <span class="nv">$withcomments</span><span class="p">);</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-12">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Must be element or document </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$element</span> <span class="nx">instanceof</span> <span class="nx">DOMElement</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$element</span> <span class="nx">instanceof</span> <span class="nx">DOMDocument</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-13">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Currently only exclusive XML is supported </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$exclusive</span> <span class="o">==</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Only exclusive canonicalization is supported in this version of PHP&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$copyDoc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
    <span class="nx">canonical</span><span class="p">(</span><span class="nv">$copyDoc</span><span class="p">,</span> <span class="nv">$element</span><span class="p">,</span> <span class="nv">$withcomments</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$copyDoc</span><span class="o">-&gt;</span><span class="na">saveXML</span><span class="p">(</span><span class="nv">$copyDoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="p">,</span> <span class="nx">LIBXML_NOEMPTYTAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">XMLSecurityKey</span> <span class="p">{</span>
    <span class="k">const</span> <span class="no">TRIPLEDES_CBC</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#tripledes-cbc&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">AES128_CBC</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#aes128-cbc&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">AES192_CBC</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#aes192-cbc&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">AES256_CBC</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#aes256-cbc&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">RSA_1_5</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#rsa-1_5&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">RSA_OAEP_MGF1P</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">DSA_SHA1</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#dsa-sha1&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">RSA_SHA1</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#rsa-sha1&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">RSA_SHA256</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&#39;</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$cryptParams</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">public</span> <span class="nv">$type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$key</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$passphrase</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$iv</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$name</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$keyChain</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$isEncrypted</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$encryptedCtx</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$guid</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-14">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>This variable contains the certificate as a string if this key represents an X509-certificate.
 If this key doesn't represent a certificate, this will be NULL.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">private</span> <span class="nv">$x509Certificate</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-15">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>This variable contains the certificate thunbprint if we have loaded an X509-certificate. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">private</span> <span class="nv">$X509Thumbprint</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$params</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">srand</span><span class="p">();</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">TRIPLEDES_CBC</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mcrypt&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_TRIPLEDES</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_MODE_CBC</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#tripledes-cbc&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">AES128_CBC</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mcrypt&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_RIJNDAEL_128</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_MODE_CBC</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#aes128-cbc&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">AES192_CBC</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mcrypt&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_RIJNDAEL_128</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_MODE_CBC</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#aes192-cbc&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">AES256_CBC</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mcrypt&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_RIJNDAEL_128</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MCRYPT_MODE_CBC</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#aes256-cbc&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">RSA_1_5</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;openssl&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">OPENSSL_PKCS1_PADDING</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#rsa-1_5&#39;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;public&#39;</span> <span class="o">||</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;private&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Certificate &quot;type&quot; (private/public) must be passed via parameters&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">RSA_OAEP_MGF1P</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;openssl&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">OPENSSL_PKCS1_OAEP_PADDING</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;public&#39;</span> <span class="o">||</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;private&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Certificate &quot;type&quot; (private/public) must be passed via parameters&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">RSA_SHA1</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;openssl&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#rsa-sha1&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">OPENSSL_PKCS1_PADDING</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;public&#39;</span> <span class="o">||</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;private&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Certificate &quot;type&quot; (private/public) must be passed via parameters&#39;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">RSA_SHA256</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;openssl&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&#39;</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">OPENSSL_PKCS1_PADDING</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;digest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SHA256&#39;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;public&#39;</span> <span class="o">||</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;private&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$params</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Certificate &quot;type&quot; (private/public) must be passed via parameters&#39;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid Key Type&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">=</span> <span class="nv">$type</span><span class="p">;</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-16">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Retrieve the key size for the symmetric encryption algorithm..</p>

<p>If the key size is unknown, or this isn't a symmetric encryption algorithm,
 NULL is returned.</p>

<p><em class='docparam'>@return</em> int|NULL  The number of bytes in the key.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSymmetricKeySize</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">];</span>
    <span class="p">}</span>
      
    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateSessionKey</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown key size for type &quot;&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">.</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$keysize</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;keysize&#39;</span><span class="p">];</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;openssl_random_pseudo_bytes&#39;</span><span class="p">))</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-17">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>We have PHP >= 5.3 - use openssl to generate session key. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="nv">$key</span> <span class="o">=</span> <span class="nb">openssl_random_pseudo_bytes</span><span class="p">(</span><span class="nv">$keysize</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-18">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Generating random key using iv generation routines </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="nv">$key</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span><span class="p">(</span><span class="nv">$keysize</span><span class="p">,</span> <span class="nx">MCRYPT_RAND</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">===</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">TRIPLEDES_CBC</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-19">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Make sure that the generated key has the proper parity bits set. Mcrypt doesn't care about the parity bits, but others may care.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$byte</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">;</span>
                <span class="nv">$parity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nv">$j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$parity</span> <span class="o">^=</span> <span class="p">(</span><span class="nv">$byte</span> <span class="o">&gt;&gt;</span> <span class="nv">$j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nv">$byte</span> <span class="o">|=</span> <span class="nv">$parity</span><span class="p">;</span>
                <span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nv">$byte</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$key</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getRawThumbprint</span><span class="p">(</span><span class="nv">$cert</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$arCert</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$cert</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="nv">$inData</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arCert</span> <span class="k">AS</span> <span class="nv">$curData</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$inData</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">strncmp</span><span class="p">(</span><span class="nv">$curData</span><span class="p">,</span> <span class="s1">&#39;-----BEGIN CERTIFICATE&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$inData</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">strncmp</span><span class="p">(</span><span class="nv">$curData</span><span class="p">,</span> <span class="s1">&#39;-----END CERTIFICATE&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$inData</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nv">$data</span> <span class="o">.=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$curData</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nb">sha1</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$data</span><span class="p">)));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">loadKey</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$isFile</span><span class="o">=</span><span class="k">FALSE</span><span class="p">,</span> <span class="nv">$isCert</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$isFile</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nv">$key</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$isCert</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">openssl_x509_read</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">);</span>
            <span class="nb">openssl_x509_export</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$str_cert</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">x509Certificate</span> <span class="o">=</span> <span class="nv">$str_cert</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nv">$str_cert</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">x509Certificate</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;openssl&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;public&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$isCert</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-20">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Load the thumbprint if this is an X509 certificate. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">X509Thumbprint</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getRawThumbprint</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">openssl_get_publickey</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nb">openssl_get_privatekey</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">passphrase</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">MCRYPT_RIJNDAEL_128</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-21">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Check key length </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">AES256_CBC</span><span class="p">)</span><span class="o">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Key must contain at least 25 characters for this cipher&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">AES192_CBC</span><span class="p">)</span><span class="o">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Key must contain at least 17 characters for this cipher&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">encryptMcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$td</span> <span class="o">=</span> <span class="nb">mcrypt_module_open</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv</span> <span class="o">=</span> <span class="nb">mcrypt_create_iv</span> <span class="p">(</span><span class="nb">mcrypt_enc_get_iv_size</span><span class="p">(</span><span class="nv">$td</span><span class="p">),</span> <span class="nx">MCRYPT_RAND</span><span class="p">);</span>
        <span class="nb">mcrypt_generic_init</span><span class="p">(</span><span class="nv">$td</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">MCRYPT_MODE_CBC</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$bs</span> <span class="o">=</span> <span class="nb">mcrypt_enc_get_block_size</span><span class="p">(</span><span class="nv">$td</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="nv">$datalen0</span><span class="o">=</span><span class="nv">$datalen</span><span class="o">=</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span> <span class="p">((</span><span class="nv">$datalen</span><span class="o">%</span><span class="nv">$bs</span><span class="p">)</span><span class="o">!=</span><span class="p">(</span><span class="nv">$bs</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span> <span class="nv">$datalen</span><span class="o">++</span><span class="p">)</span>
                <span class="nv">$data</span><span class="o">.=</span><span class="nb">chr</span><span class="p">(</span><span class="nx">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">127</span><span class="p">));</span>
            <span class="nv">$data</span><span class="o">.=</span><span class="nb">chr</span><span class="p">(</span><span class="nv">$datalen</span><span class="o">-</span><span class="nv">$datalen0</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$encrypted_data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv</span><span class="o">.</span><span class="nb">mcrypt_generic</span><span class="p">(</span><span class="nv">$td</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
        <span class="nb">mcrypt_generic_deinit</span><span class="p">(</span><span class="nv">$td</span><span class="p">);</span>
        <span class="nb">mcrypt_module_close</span><span class="p">(</span><span class="nv">$td</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$encrypted_data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">decryptMcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$td</span> <span class="o">=</span> <span class="nb">mcrypt_module_open</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;cipher&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nv">$iv_length</span> <span class="o">=</span> <span class="nb">mcrypt_enc_get_iv_size</span><span class="p">(</span><span class="nv">$td</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$iv_length</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$iv_length</span><span class="p">);</span>

        <span class="nb">mcrypt_generic_init</span><span class="p">(</span><span class="nv">$td</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iv</span><span class="p">);</span>
        <span class="nv">$decrypted_data</span> <span class="o">=</span> <span class="nb">mdecrypt_generic</span><span class="p">(</span><span class="nv">$td</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
        <span class="nb">mcrypt_generic_deinit</span><span class="p">(</span><span class="nv">$td</span><span class="p">);</span>
        <span class="nb">mcrypt_module_close</span><span class="p">(</span><span class="nv">$td</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nx">MCRYPT_MODE_CBC</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$dataLen</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$decrypted_data</span><span class="p">);</span>
            <span class="nv">$paddingLength</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$decrypted_data</span><span class="p">,</span> <span class="nv">$dataLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nv">$decrypted_data</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$decrypted_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$dataLen</span> <span class="o">-</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$paddingLength</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$decrypted_data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">encryptOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;public&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">openssl_public_encrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$encrypted_data</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Failure encrypting Data&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">openssl_private_encrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$encrypted_data</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Failure encrypting Data&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$encrypted_data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">decryptOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;public&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">openssl_public_decrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$decrypted</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Failure decrypting Data&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">openssl_private_decrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$decrypted</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;padding&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Failure decrypting Data&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$decrypted</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">signOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
     <span class="nv">$algo</span> <span class="o">=</span> <span class="nx">OPENSSL_ALGO_SHA1</span><span class="p">;</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;digest&#39;</span><span class="p">]))</span> <span class="p">{</span>
         <span class="nv">$algo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;digest&#39;</span><span class="p">];</span>
     <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">openssl_sign</span> <span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$algo</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Failure Signing Data: &#39;</span> <span class="o">.</span> <span class="nb">openssl_error_string</span><span class="p">()</span> <span class="o">.</span> <span class="s1">&#39; - &#39;</span> <span class="o">.</span> <span class="nv">$algo</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$signature</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">verifyOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">)</span> <span class="p">{</span>
     <span class="nv">$algo</span> <span class="o">=</span> <span class="nx">OPENSSL_ALGO_SHA1</span><span class="p">;</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;digest&#39;</span><span class="p">]))</span> <span class="p">{</span>
         <span class="nv">$algo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;digest&#39;</span><span class="p">];</span>
     <span class="p">}</span>
        <span class="k">return</span> <span class="nb">openssl_verify</span> <span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">,</span> <span class="nv">$algo</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">encryptData</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;mcrypt&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encryptMcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;openssl&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encryptOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">decryptData</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;mcrypt&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">decryptMcrypt</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;openssl&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">decryptOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">signData</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;openssl&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">signOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">verifySignature</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;openssl&#39;</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">verifyOpenSSL</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getAlgorith</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">cryptParams</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="nf">makeAsnSegment</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$type</span><span class="p">){</span>
            <span class="k">case</span> <span class="mh">0x02</span><span class="o">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span>
                    <span class="nv">$string</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="nv">$string</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x03</span><span class="o">:</span>
                <span class="nv">$string</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="nv">$string</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$length</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$length</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">){</span>
           <span class="nv">$output</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;%c%c%s&quot;</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$length</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$length</span> <span class="o">&lt;</span> <span class="mh">0x0100</span><span class="p">){</span>
           <span class="nv">$output</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;%c%c%c%s&quot;</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="nv">$length</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$length</span> <span class="o">&lt;</span> <span class="mh">0x010000</span><span class="p">)</span> <span class="p">{</span>
           <span class="nv">$output</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s2">&quot;%c%c%c%c%s&quot;</span><span class="p">,</span> <span class="nv">$type</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="nv">$length</span><span class="o">/</span><span class="mh">0x0100</span><span class="p">,</span> <span class="nv">$length</span><span class="o">%</span><span class="mh">0x0100</span><span class="p">,</span> <span class="nv">$string</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$output</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">(</span><span class="nv">$output</span><span class="p">);</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-22">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Modulus and Exponent must already be base64 decoded </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">static</span> <span class="k">function</span> <span class="nf">convertRSA</span><span class="p">(</span><span class="nv">$modulus</span><span class="p">,</span> <span class="nv">$exponent</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-23">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>make an ASN publicKeyInfo </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="nv">$exponentEncoding</span> <span class="o">=</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">makeAsnSegment</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="nv">$exponent</span><span class="p">);</span>
        <span class="nv">$modulusEncoding</span> <span class="o">=</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">makeAsnSegment</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="nv">$modulus</span><span class="p">);</span>
        <span class="nv">$sequenceEncoding</span> <span class="o">=</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span> <span class="na">makeAsnSegment</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="nv">$modulusEncoding</span><span class="o">.</span><span class="nv">$exponentEncoding</span><span class="p">);</span>
        <span class="nv">$bitstringEncoding</span> <span class="o">=</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">makeAsnSegment</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="nv">$sequenceEncoding</span><span class="p">);</span>
        <span class="nv">$rsaAlgorithmIdentifier</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s2">&quot;H*&quot;</span><span class="p">,</span> <span class="s2">&quot;300D06092A864886F70D0101010500&quot;</span><span class="p">);</span>
        <span class="nv">$publicKeyInfo</span> <span class="o">=</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">makeAsnSegment</span> <span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="nv">$rsaAlgorithmIdentifier</span><span class="o">.</span><span class="nv">$bitstringEncoding</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-24">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>encode the publicKeyInfo in base64 and add PEM brackets </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="nv">$publicKeyInfoBase64</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$publicKeyInfo</span><span class="p">);</span>
        <span class="nv">$encoding</span> <span class="o">=</span> <span class="s2">&quot;-----BEGIN PUBLIC KEY-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="nv">$offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$segment</span><span class="o">=</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$publicKeyInfoBase64</span><span class="p">,</span> <span class="nv">$offset</span><span class="p">,</span> <span class="mi">64</span><span class="p">)){</span>
           <span class="nv">$encoding</span> <span class="o">=</span> <span class="nv">$encoding</span><span class="o">.</span><span class="nv">$segment</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
           <span class="nv">$offset</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$encoding</span><span class="o">.</span><span class="s2">&quot;-----END PUBLIC KEY-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">serializeKey</span><span class="p">(</span><span class="nv">$parent</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-25">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Retrieve the X509 certificate this key represents.</p>

<p>Will return the X509 certificate in PEM-format if this key represents
 an X509 certificate.</p>

<p><em class='docparam'>@return</em>  The X509 certificate or NULL if this key doesn't represent an X509-certificate.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getX509Certificate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">x509Certificate</span><span class="p">;</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-26">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Get the thumbprint of this X509 certificate.
 Returns:
  The thumbprint as a lowercase 40-character hexadecimal number, or NULL
  if this isn't a X509 certificate.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getX509Thumbprint</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">X509Thumbprint</span><span class="p">;</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-27">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Create key from an EncryptedKey-element.</p>

<p><em class='docparam'>@param</em> DOMElement $element  The EncryptedKey-element.
<em class='docparam'>@return</em> XMLSecurityKey  The new key.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">fromEncryptedKeyElement</span><span class="p">(</span><span class="nx">DOMElement</span> <span class="nv">$element</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$objenc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLSecEnc</span><span class="p">();</span>
        <span class="nv">$objenc</span><span class="o">-&gt;</span><span class="na">setNode</span><span class="p">(</span><span class="nv">$element</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$objKey</span> <span class="o">=</span> <span class="nv">$objenc</span><span class="o">-&gt;</span><span class="na">locateKey</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to locate algorithm for this Encrypted Key&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">isEncrypted</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
        <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">encryptedCtx</span> <span class="o">=</span> <span class="nv">$objenc</span><span class="p">;</span>
        <span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">staticLocateKeyInfo</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$element</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$objKey</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">class</span> <span class="nc">XMLSecurityDSig</span> <span class="p">{</span>
    <span class="k">const</span> <span class="no">XMLDSIGNS</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">SHA1</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#sha1&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">SHA256</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#sha256&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">SHA512</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#sha512&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">RIPEMD160</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#ripemd160&#39;</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">C14N</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">C14N_COMMENTS</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">EXC_C14N</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">EXC_C14N_COMMENTS</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#WithComments&#39;</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">template</span> <span class="o">=</span> <span class="s1">&#39;&lt;ds:Signature xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;</span>
<span class="s1">  &lt;ds:SignedInfo&gt;</span>
<span class="s1">    &lt;ds:SignatureMethod /&gt;</span>
<span class="s1">  &lt;/ds:SignedInfo&gt;</span>
<span class="s1">&lt;/ds:Signature&gt;&#39;</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$sigNode</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$idKeys</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">public</span> <span class="nv">$idNS</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">private</span> <span class="nv">$signedInfo</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$xPathCtx</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$canonicalMethod</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s1">&#39;ds&#39;</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$searchpfx</span> <span class="o">=</span> <span class="s1">&#39;secdsig&#39;</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-28">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>This variable contains an associative array of validated nodes. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">private</span> <span class="nv">$validatedNodes</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$sigdoc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
        <span class="nv">$sigdoc</span><span class="o">-&gt;</span><span class="na">loadXML</span><span class="p">(</span><span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">template</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span> <span class="o">=</span> <span class="nv">$sigdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">resetXPathObj</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">xPathCtx</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="k">private</span> <span class="k">function</span> <span class="nf">getXPathObj</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">xPathCtx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">);</span>
            <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;secdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">xPathCtx</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">xPathCtx</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="nf">generate_GUID</span><span class="p">(</span><span class="nv">$prefix</span><span class="o">=</span><span class="s1">&#39;pfx&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$uuid</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nb">uniqid</span><span class="p">(</span><span class="nx">rand</span><span class="p">(),</span> <span class="k">true</span><span class="p">));</span>
        <span class="nv">$guid</span> <span class="o">=</span>  <span class="nv">$prefix</span><span class="o">.</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$uuid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;-&quot;</span><span class="o">.</span>
                <span class="nx">substr</span><span class="p">(</span><span class="nv">$uuid</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;-&quot;</span><span class="o">.</span>
                <span class="nx">substr</span><span class="p">(</span><span class="nv">$uuid</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;-&quot;</span><span class="o">.</span>
                <span class="nx">substr</span><span class="p">(</span><span class="nv">$uuid</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;-&quot;</span><span class="o">.</span>
                <span class="nx">substr</span><span class="p">(</span><span class="nv">$uuid</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$guid</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">locateSignature</span><span class="p">(</span><span class="nv">$objDoc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$objDoc</span> <span class="nx">instanceof</span> <span class="nx">DOMDocument</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$objDoc</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$objDoc</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$doc</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
            <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;secdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;.//secdsig:Signature&quot;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$objDoc</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createNewSignNode</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$value</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prefix</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nv">$name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setCanonicalMethod</span><span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$method</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#WithComments&#39;</span><span class="o">:</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalMethod</span> <span class="o">=</span> <span class="nv">$method</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid Canonical Method&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">searchpfx</span><span class="o">.</span><span class="s1">&#39;:SignedInfo&#39;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$sinfo</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">searchpfx</span><span class="o">.</span><span class="s1">&#39;CanonicalizationMethod&#39;</span><span class="p">;</span>
                <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$sinfo</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="nv">$canonNode</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
                    <span class="nv">$canonNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;CanonicalizationMethod&#39;</span><span class="p">);</span>
                    <span class="nv">$sinfo</span><span class="o">-&gt;</span><span class="na">insertBefore</span><span class="p">(</span><span class="nv">$canonNode</span><span class="p">,</span> <span class="nv">$sinfo</span><span class="o">-&gt;</span><span class="na">firstChild</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nv">$canonNode</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalMethod</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">canonicalizeData</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$canonicalmethod</span><span class="p">,</span> <span class="nv">$arXPath</span><span class="o">=</span><span class="k">NULL</span><span class="p">,</span> <span class="nv">$prefixList</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$exclusive</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
        <span class="nv">$withComments</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$canonicalmethod</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&#39;</span><span class="o">:</span>
                <span class="nv">$exclusive</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
                <span class="nv">$withComments</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments&#39;</span><span class="o">:</span>
                <span class="nv">$withComments</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#&#39;</span><span class="o">:</span>
                <span class="nv">$exclusive</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#WithComments&#39;</span><span class="o">:</span>
                <span class="nv">$exclusive</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
                <span class="nv">$withComments</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-29">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Support PHP versions &lt; 5.2 not containing C14N methods in DOM extension </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="nv">$php_version</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="k">PHP_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="nv">$php_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$php_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="nv">$php_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">is_null</span><span class="p">(</span><span class="nv">$arXPath</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;PHP 5.2.0 or higher is required to perform XPath Transformations&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">C14NGeneral</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$exclusive</span><span class="p">,</span> <span class="nv">$withComments</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">C14N</span><span class="p">(</span><span class="nv">$exclusive</span><span class="p">,</span> <span class="nv">$withComments</span><span class="p">,</span> <span class="nv">$arXPath</span><span class="p">,</span> <span class="nv">$prefixList</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">canonicalizeSignedInfo</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="nv">$canonicalmethod</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$doc</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">();</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:SignedInfo&quot;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$signInfoNode</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:CanonicalizationMethod&quot;</span><span class="p">;</span>
                <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$signInfoNode</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$canonNode</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$canonicalmethod</span> <span class="o">=</span> <span class="nv">$canonNode</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">signedInfo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalizeData</span><span class="p">(</span><span class="nv">$signInfoNode</span><span class="p">,</span> <span class="nv">$canonicalmethod</span><span class="p">);</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">signedInfo</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">calculateDigest</span> <span class="p">(</span><span class="nv">$digestAlgorithm</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$digestAlgorithm</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">SHA1</span><span class="o">:</span>
                <span class="nv">$alg</span> <span class="o">=</span> <span class="s1">&#39;sha1&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">SHA256</span><span class="o">:</span>
                <span class="nv">$alg</span> <span class="o">=</span> <span class="s1">&#39;sha256&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">SHA512</span><span class="o">:</span>
                <span class="nv">$alg</span> <span class="o">=</span> <span class="s1">&#39;sha512&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">RIPEMD160</span><span class="o">:</span>
                <span class="nv">$alg</span> <span class="o">=</span> <span class="s1">&#39;ripemd160&#39;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot validate digest: Unsupported Algorith &lt;</span><span class="si">$digestAlgorithm</span><span class="s2">&gt;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="nv">$alg</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;mhash&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$alg</span> <span class="o">=</span> <span class="s2">&quot;MHASH_&quot;</span> <span class="o">.</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$alg</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">mhash</span><span class="p">(</span><span class="nb">constant</span><span class="p">(</span><span class="nv">$alg</span><span class="p">),</span> <span class="nv">$data</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$alg</span> <span class="o">===</span> <span class="s1">&#39;sha1&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">sha1</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;xmlseclibs is unable to calculate a digest. Maybe you need the mhash library?&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">validateDigest</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">);</span>
        <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;secdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;string(./secdsig:DigestMethod/@Algorithm)&#39;</span><span class="p">;</span>
        <span class="nv">$digestAlgorithm</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">evaluate</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$refNode</span><span class="p">);</span>
        <span class="nv">$digValue</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">calculateDigest</span><span class="p">(</span><span class="nv">$digestAlgorithm</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;string(./secdsig:DigestValue)&#39;</span><span class="p">;</span>
        <span class="nv">$digestValue</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">evaluate</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$refNode</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="nv">$digValue</span> <span class="o">==</span> <span class="nv">$digestValue</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">processTransforms</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">,</span> <span class="nv">$objData</span><span class="p">,</span> <span class="nv">$includeCommentNodes</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$objData</span><span class="p">;</span>
        <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">);</span>
        <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;secdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;./secdsig:Transforms/secdsig:Transform&#39;</span><span class="p">;</span>
        <span class="nv">$nodelist</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$refNode</span><span class="p">);</span>
        <span class="nv">$canonicalMethod</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&#39;</span><span class="p">;</span>
        <span class="nv">$arXPath</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="nv">$prefixList</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodelist</span> <span class="k">AS</span> <span class="nv">$transform</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$algorithm</span> <span class="o">=</span> <span class="nv">$transform</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">);</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$algorithm</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#&#39;</span><span class="o">:</span>
                <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#WithComments&#39;</span><span class="o">:</span>

                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$includeCommentNodes</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-30">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>We remove comment nodes by forcing it to use a canonicalization without comments.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>                        <span class="nv">$canonicalMethod</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/10/xml-exc-c14n#&#39;</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$canonicalMethod</span> <span class="o">=</span> <span class="nv">$algorithm</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$transform</span><span class="o">-&gt;</span><span class="na">firstChild</span><span class="p">;</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">localName</span> <span class="o">==</span> <span class="s1">&#39;InclusiveNamespaces&#39;</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nv">$pfx</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;PrefixList&#39;</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nv">$arpfx</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                                <span class="nv">$pfxlist</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nv">$pfx</span><span class="p">);</span>
                                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$pfxlist</span> <span class="k">AS</span> <span class="nv">$pfx</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nv">$val</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$pfx</span><span class="p">);</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$val</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="nv">$arpfx</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$arpfx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nv">$prefixList</span> <span class="o">=</span> <span class="nv">$arpfx</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nextSibling</span><span class="p">;</span>
                    <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&#39;</span><span class="o">:</span>
                <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments&#39;</span><span class="o">:</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$includeCommentNodes</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-31">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>We remove comment nodes by forcing it to use a canonicalization without comments.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>                        <span class="nv">$canonicalMethod</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/TR/2001/REC-xml-c14n-20010315&#39;</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nv">$canonicalMethod</span> <span class="o">=</span> <span class="nv">$algorithm</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;</span><span class="o">:</span>
                    <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$transform</span><span class="o">-&gt;</span><span class="na">firstChild</span><span class="p">;</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">localName</span> <span class="o">==</span> <span class="s1">&#39;XPath&#39;</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nv">$arXPath</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                            <span class="nv">$arXPath</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(.//. | .//@* | .//namespace::*)[&#39;</span><span class="o">.</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nodeValue</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">;</span>
                            <span class="nv">$arXpath</span><span class="p">[</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
                            <span class="nv">$nslist</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">&#39;./namespace::*&#39;</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
                            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nslist</span> <span class="k">AS</span> <span class="nv">$nsnode</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nv">$nsnode</span><span class="o">-&gt;</span><span class="na">localName</span> <span class="o">!=</span> <span class="s2">&quot;xml&quot;</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nv">$arXPath</span><span class="p">[</span><span class="s1">&#39;namespaces&#39;</span><span class="p">][</span><span class="nv">$nsnode</span><span class="o">-&gt;</span><span class="na">localName</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$nsnode</span><span class="o">-&gt;</span><span class="na">nodeValue</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nextSibling</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span> <span class="nx">instanceof</span> <span class="nx">DOMNode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalizeData</span><span class="p">(</span><span class="nv">$objData</span><span class="p">,</span> <span class="nv">$canonicalMethod</span><span class="p">,</span> <span class="nv">$arXPath</span><span class="p">,</span> <span class="nv">$prefixList</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">processRefNode</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$dataObject</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span></pre></div>            </td>
          </tr>
                  <tr id="section-32">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Depending on the URI, we may not want to include comments in the result
 See: http:www.w3.org/TR/xmldsig-core/#sec-ReferenceProcessingModel</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="nv">$includeCommentNodes</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$arUrl</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$arUrl</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$identifier</span> <span class="o">=</span> <span class="nv">$arUrl</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">])</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-33">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>This reference identifies a node with the given id by using a URI on the form "#identifier". This should not include comments.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>                    <span class="nv">$includeCommentNodes</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>

                    <span class="nv">$xPath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">idNS</span> <span class="o">&amp;&amp;</span> <span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">idNS</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">idNS</span> <span class="k">AS</span> <span class="nv">$nspf</span><span class="o">=&gt;</span><span class="nv">$ns</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="nv">$nspf</span><span class="p">,</span> <span class="nv">$ns</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="nv">$iDlist</span> <span class="o">=</span> <span class="s1">&#39;@Id=&quot;&#39;</span><span class="o">.</span><span class="nv">$identifier</span><span class="o">.</span><span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">idKeys</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">idKeys</span> <span class="k">AS</span> <span class="nv">$idKey</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nv">$iDlist</span> <span class="o">.=</span> <span class="s2">&quot; or @</span><span class="si">$idKey</span><span class="s2">=&#39;</span><span class="si">$identifier</span><span class="s2">&#39;&quot;</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="nv">$query</span> <span class="o">=</span> <span class="s1">&#39;//*[&#39;</span><span class="o">.</span><span class="nv">$iDlist</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">;</span>
                    <span class="nv">$dataObject</span> <span class="o">=</span> <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$dataObject</span> <span class="o">=</span> <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$dataObject</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$arUrl</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-34">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>This reference identifies the root node with an empty URI. This should not include comments.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="nv">$includeCommentNodes</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>

            <span class="nv">$dataObject</span> <span class="o">=</span> <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processTransforms</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">,</span> <span class="nv">$dataObject</span><span class="p">,</span> <span class="nv">$includeCommentNodes</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validateDigest</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">,</span> <span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$dataObject</span> <span class="nx">instanceof</span> <span class="nx">DOMNode</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-35">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Add this node to the list of validated nodes. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$identifier</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validatedNodes</span><span class="p">[</span><span class="nv">$identifier</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$dataObject</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validatedNodes</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$dataObject</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRefNodeID</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$arUrl</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$uri</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$arUrl</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$identifier</span> <span class="o">=</span> <span class="nv">$arUrl</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$identifier</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRefIDs</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$refids</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>

        <span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">();</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:SignedInfo/secdsig:Reference&quot;</span><span class="p">;</span>
        <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Reference nodes not found&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodeset</span> <span class="k">AS</span> <span class="nv">$refNode</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$refids</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRefNodeID</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$refids</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">validateReference</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">isSameNode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">removeChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">();</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:SignedInfo/secdsig:Reference&quot;</span><span class="p">;</span>
        <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Reference nodes not found&quot;</span><span class="p">);</span>
        <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-36">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Initialize/reset the list of validated nodes. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validatedNodes</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$nodeset</span> <span class="k">AS</span> <span class="nv">$refNode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processRefNode</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">))</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-37">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Clear the list of validated nodes. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validatedNodes</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Reference validation failed&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">addRefInternal</span><span class="p">(</span><span class="nv">$sinfoNode</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$algorithm</span><span class="p">,</span> <span class="nv">$arTransforms</span><span class="o">=</span><span class="k">NULL</span><span class="p">,</span> <span class="nv">$options</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$prefix</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="nv">$prefix_ns</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="nv">$id_name</span> <span class="o">=</span> <span class="s1">&#39;Id&#39;</span><span class="p">;</span>
        <span class="nv">$overwrite_id</span>  <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
        <span class="nv">$force_uri</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$options</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$prefix</span> <span class="o">=</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">])</span><span class="o">?</span><span class="k">NULL</span><span class="o">:</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">];</span>
            <span class="nv">$prefix_ns</span> <span class="o">=</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;prefix_ns&#39;</span><span class="p">])</span><span class="o">?</span><span class="k">NULL</span><span class="o">:</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;prefix_ns&#39;</span><span class="p">];</span>
            <span class="nv">$id_name</span> <span class="o">=</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;id_name&#39;</span><span class="p">])</span><span class="o">?</span><span class="s1">&#39;Id&#39;</span><span class="o">:</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;id_name&#39;</span><span class="p">];</span>
            <span class="nv">$overwrite_id</span> <span class="o">=</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;overwrite&#39;</span><span class="p">])</span><span class="o">?</span><span class="k">TRUE</span><span class="o">:</span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;overwrite&#39;</span><span class="p">];</span>
            <span class="nv">$force_uri</span> <span class="o">=</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;force_uri&#39;</span><span class="p">])</span><span class="o">?</span><span class="k">FALSE</span><span class="o">:</span><span class="p">(</span><span class="nx">bool</span><span class="p">)</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;force_uri&#39;</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nv">$attname</span> <span class="o">=</span> <span class="nv">$id_name</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$prefix</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$attname</span> <span class="o">=</span> <span class="nv">$prefix</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nv">$attname</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$refNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;Reference&#39;</span><span class="p">);</span>
        <span class="nv">$sinfoNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$node</span> <span class="nx">instanceof</span> <span class="nx">DOMDocument</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$uri</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$overwrite_id</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">getAttributeNS</span><span class="p">(</span><span class="nv">$prefix_ns</span><span class="p">,</span> <span class="nv">$attname</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$uri</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$uri</span> <span class="o">=</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">generate_GUID</span><span class="p">();</span>
                <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">setAttributeNS</span><span class="p">(</span><span class="nv">$prefix_ns</span><span class="p">,</span> <span class="nv">$attname</span><span class="p">,</span> <span class="nv">$uri</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="o">.</span><span class="nv">$uri</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$force_uri</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$transNodes</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;Transforms&#39;</span><span class="p">);</span>
        <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$transNodes</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$arTransforms</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arTransforms</span> <span class="k">AS</span> <span class="nv">$transform</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$transNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;Transform&#39;</span><span class="p">);</span>
                <span class="nv">$transNodes</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$transNode</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$transform</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
                    <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$transform</span><span class="p">[</span><span class="s1">&#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;</span><span class="p">]))</span> <span class="o">&amp;&amp;</span> 
                    <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$transform</span><span class="p">[</span><span class="s1">&#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">])))</span> <span class="p">{</span>
                    <span class="nv">$transNode</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="s1">&#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;</span><span class="p">);</span>
                    <span class="nv">$XPathNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;XPath&#39;</span><span class="p">,</span> <span class="nv">$transform</span><span class="p">[</span><span class="s1">&#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">]);</span>
                    <span class="nv">$transNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$XPathNode</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$transform</span><span class="p">[</span><span class="s1">&#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]))</span> <span class="p">{</span>
                        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$transform</span><span class="p">[</span><span class="s1">&#39;http://www.w3.org/TR/1999/REC-xpath-19991116&#39;</span><span class="p">][</span><span class="s1">&#39;namespaces&#39;</span><span class="p">]</span> <span class="k">AS</span> <span class="nv">$prefix</span> <span class="o">=&gt;</span> <span class="nv">$namespace</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nv">$XPathNode</span><span class="o">-&gt;</span><span class="na">setAttributeNS</span><span class="p">(</span><span class="s2">&quot;http://www.w3.org/2000/xmlns/&quot;</span><span class="p">,</span> <span class="s2">&quot;xmlns:</span><span class="si">$prefix</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$namespace</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$transNode</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="nv">$transform</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalMethod</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$transNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;Transform&#39;</span><span class="p">);</span>
            <span class="nv">$transNodes</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$transNode</span><span class="p">);</span>
            <span class="nv">$transNode</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalMethod</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$canonicalData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">processTransforms</span><span class="p">(</span><span class="nv">$refNode</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
        <span class="nv">$digValue</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">calculateDigest</span><span class="p">(</span><span class="nv">$algorithm</span><span class="p">,</span> <span class="nv">$canonicalData</span><span class="p">);</span>

        <span class="nv">$digestMethod</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;DigestMethod&#39;</span><span class="p">);</span>
        <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$digestMethod</span><span class="p">);</span>
        <span class="nv">$digestMethod</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="nv">$algorithm</span><span class="p">);</span>

        <span class="nv">$digestValue</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;DigestValue&#39;</span><span class="p">,</span> <span class="nv">$digValue</span><span class="p">);</span>
        <span class="nv">$refNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$digestValue</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addReference</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$algorithm</span><span class="p">,</span> <span class="nv">$arTransforms</span><span class="o">=</span><span class="k">NULL</span><span class="p">,</span> <span class="nv">$options</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:SignedInfo&quot;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$sInfo</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addRefInternal</span><span class="p">(</span><span class="nv">$sInfo</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$algorithm</span><span class="p">,</span> <span class="nv">$arTransforms</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addReferenceList</span><span class="p">(</span><span class="nv">$arNodes</span><span class="p">,</span> <span class="nv">$algorithm</span><span class="p">,</span> <span class="nv">$arTransforms</span><span class="o">=</span><span class="k">NULL</span><span class="p">,</span> <span class="nv">$options</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:SignedInfo&quot;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$sInfo</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arNodes</span> <span class="k">AS</span> <span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addRefInternal</span><span class="p">(</span><span class="nv">$sInfo</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$algorithm</span><span class="p">,</span> <span class="nv">$arTransforms</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

   <span class="k">public</span> <span class="k">function</span> <span class="nf">addObject</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$mimetype</span><span class="o">=</span><span class="k">NULL</span><span class="p">,</span> <span class="nv">$encoding</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$objNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;Object&#39;</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$objNode</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$mimetype</span><span class="p">))</span> <span class="p">{</span>
         <span class="nv">$objNode</span><span class="o">-&gt;</span><span class="na">setAtribute</span><span class="p">(</span><span class="s1">&#39;MimeType&#39;</span><span class="p">,</span> <span class="nv">$mimetype</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$encoding</span><span class="p">))</span> <span class="p">{</span>
         <span class="nv">$objNode</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Encoding&#39;</span><span class="p">,</span> <span class="nv">$encoding</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span> <span class="nx">instanceof</span> <span class="nx">DOMElement</span><span class="p">)</span> <span class="p">{</span>
         <span class="nv">$newData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="o">-&gt;</span><span class="na">importNode</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nv">$newData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="o">-&gt;</span><span class="na">createTextNode</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nv">$objNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$newData</span><span class="p">);</span>

      <span class="k">return</span> <span class="nv">$objNode</span><span class="p">;</span>
   <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">locateKey</span><span class="p">(</span><span class="nv">$node</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$node</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$node</span> <span class="nx">instanceof</span> <span class="nx">DOMNode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
            <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;secdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;string(./secdsig:SignedInfo/secdsig:SignatureMethod/@Algorithm)&quot;</span><span class="p">;</span>
            <span class="nv">$algorithm</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">evaluate</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$algorithm</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nv">$objKey</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLSecurityKey</span><span class="p">(</span><span class="nv">$algorithm</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;public&#39;</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nv">$objKey</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">verify</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
        <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;secdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;string(./secdsig:SignatureValue)&quot;</span><span class="p">;</span>
        <span class="nv">$sigValue</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">evaluate</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$sigValue</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to locate SignatureValue&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">verifySignature</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">signedInfo</span><span class="p">,</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$sigValue</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">signData</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">signData</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">sign</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$appendToNode</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-38">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>If we have a parent node append it now so C14N properly works</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nv">$appendToNode</span> <span class="o">!=</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">resetXPathObj</span><span class="p">();</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">appendSignature</span><span class="p">(</span><span class="nv">$appendToNode</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span> <span class="o">=</span> <span class="nv">$appendToNode</span><span class="o">-&gt;</span><span class="na">lastChild</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:SignedInfo&quot;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$sInfo</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:SignatureMethod&quot;</span><span class="p">;</span>
                <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$sInfo</span><span class="p">);</span>
                <span class="nv">$sMethod</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="nv">$sMethod</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">);</span>
                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalizeData</span><span class="p">(</span><span class="nv">$sInfo</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canonicalMethod</span><span class="p">);</span>
                <span class="nv">$sigValue</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">signData</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$data</span><span class="p">));</span>
                <span class="nv">$sigValueNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNewSignNode</span><span class="p">(</span><span class="s1">&#39;SignatureValue&#39;</span><span class="p">,</span> <span class="nv">$sigValue</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$infoSibling</span> <span class="o">=</span> <span class="nv">$sInfo</span><span class="o">-&gt;</span><span class="na">nextSibling</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$infoSibling</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">insertBefore</span><span class="p">(</span><span class="nv">$sigValueNode</span><span class="p">,</span> <span class="nv">$infoSibling</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$sigValueNode</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">appendCert</span><span class="p">()</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">appendKey</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$parent</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">serializeKey</span><span class="p">(</span><span class="nv">$parent</span><span class="p">);</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-39">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>This function inserts the signature element.</p>

<p>The signature element will be appended to the element, unless $beforeNode is specified. If $beforeNode
 is specified, the signature element will be inserted as the last element before $beforeNode.</p>

<p><em class='docparam'>@param</em> $node  The node the signature element should be inserted into.
<em class='docparam'>@param</em> $beforeNode  The node the signature element should be located before.</p>

<p><em class='docparam'>@return</em> DOMNode The signature element node</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">insertSignature</span><span class="p">(</span><span class="nv">$node</span><span class="p">,</span> <span class="nv">$beforeNode</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="nv">$document</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="nv">$signatureElement</span> <span class="o">=</span> <span class="nv">$document</span><span class="o">-&gt;</span><span class="na">importNode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$beforeNode</span> <span class="o">==</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">insertBefore</span><span class="p">(</span><span class="nv">$signatureElement</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">insertBefore</span><span class="p">(</span><span class="nv">$signatureElement</span><span class="p">,</span> <span class="nv">$beforeNode</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">appendSignature</span><span class="p">(</span><span class="nv">$parentNode</span><span class="p">,</span> <span class="nv">$insertBefore</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$beforeNode</span> <span class="o">=</span> <span class="nv">$insertBefore</span> <span class="o">?</span> <span class="nv">$parentNode</span><span class="o">-&gt;</span><span class="na">firstChild</span> <span class="o">:</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">insertSignature</span><span class="p">(</span><span class="nv">$parentNode</span><span class="p">,</span> <span class="nv">$beforeNode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="nf">get509XCert</span><span class="p">(</span><span class="nv">$cert</span><span class="p">,</span> <span class="nv">$isPEMFormat</span><span class="o">=</span><span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$certs</span> <span class="o">=</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">staticGet509XCerts</span><span class="p">(</span><span class="nv">$cert</span><span class="p">,</span> <span class="nv">$isPEMFormat</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$certs</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$certs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="nf">staticGet509XCerts</span><span class="p">(</span><span class="nv">$certs</span><span class="p">,</span> <span class="nv">$isPEMFormat</span><span class="o">=</span><span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$isPEMFormat</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="nv">$certlist</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="nv">$arCert</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$certs</span><span class="p">);</span>
            <span class="nv">$inData</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arCert</span> <span class="k">AS</span> <span class="nv">$curData</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$inData</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">strncmp</span><span class="p">(</span><span class="nv">$curData</span><span class="p">,</span> <span class="s1">&#39;-----BEGIN CERTIFICATE&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$inData</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">strncmp</span><span class="p">(</span><span class="nv">$curData</span><span class="p">,</span> <span class="s1">&#39;-----END CERTIFICATE&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$inData</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
                        <span class="nv">$certlist</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
                        <span class="nv">$data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nv">$data</span> <span class="o">.=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$curData</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$certlist</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$certs</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="nf">staticAdd509Cert</span><span class="p">(</span><span class="nv">$parentRef</span><span class="p">,</span> <span class="nv">$cert</span><span class="p">,</span> <span class="nv">$isPEMFormat</span><span class="o">=</span><span class="k">TRUE</span><span class="p">,</span> <span class="nv">$isURL</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="nv">$xpath</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$isURL</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$cert</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$cert</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$parentRef</span> <span class="nx">instanceof</span> <span class="nx">DOMElement</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid parent Node parameter&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nv">$baseDoc</span> <span class="o">=</span> <span class="nv">$parentRef</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$xpath</span><span class="p">))</span> <span class="p">{</span>
              <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$parentRef</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">);</span>
              <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;secdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
          <span class="p">}</span>

         <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:KeyInfo&quot;</span><span class="p">;</span>
         <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$parentRef</span><span class="p">);</span>
         <span class="nv">$keyInfo</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$keyInfo</span><span class="p">)</span> <span class="p">{</span>
              <span class="nv">$inserted</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
              <span class="nv">$keyInfo</span> <span class="o">=</span> <span class="nv">$baseDoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">,</span> <span class="s1">&#39;ds:KeyInfo&#39;</span><span class="p">);</span>

               <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./secdsig:Object&quot;</span><span class="p">;</span>
               <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$parentRef</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nv">$sObject</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$sObject</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">insertBefore</span><span class="p">(</span><span class="nv">$keyInfo</span><span class="p">,</span> <span class="nv">$sObject</span><span class="p">);</span>
                    <span class="nv">$inserted</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
               <span class="p">}</span>

              <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$inserted</span><span class="p">)</span> <span class="p">{</span>
                   <span class="nv">$parentRef</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$keyInfo</span><span class="p">);</span>
              <span class="p">}</span>
         <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-40">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Add all certs if there are more than one</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>         <span class="nv">$certs</span> <span class="o">=</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">staticGet509XCerts</span><span class="p">(</span><span class="nv">$cert</span><span class="p">,</span> <span class="nv">$isPEMFormat</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-41">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Atach X509 data node</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>         <span class="nv">$x509DataNode</span> <span class="o">=</span> <span class="nv">$baseDoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">,</span> <span class="s1">&#39;ds:X509Data&#39;</span><span class="p">);</span>
         <span class="nv">$keyInfo</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$x509DataNode</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-42">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Atach all certificate nodes</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>         <span class="k">foreach</span> <span class="p">(</span><span class="nv">$certs</span> <span class="k">as</span> <span class="nv">$X509Cert</span><span class="p">){</span>
            <span class="nv">$x509CertNode</span> <span class="o">=</span> <span class="nv">$baseDoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">,</span> <span class="s1">&#39;ds:X509Certificate&#39;</span><span class="p">,</span> <span class="nv">$X509Cert</span><span class="p">);</span>
         <span class="nv">$x509DataNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$x509CertNode</span><span class="p">);</span>
         <span class="p">}</span>
     <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">add509Cert</span><span class="p">(</span><span class="nv">$cert</span><span class="p">,</span> <span class="nv">$isPEMFormat</span><span class="o">=</span><span class="k">TRUE</span><span class="p">,</span> <span class="nv">$isURL</span><span class="o">=</span><span class="k">False</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nv">$xpath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getXPathObj</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">staticAdd509Cert</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sigNode</span><span class="p">,</span> <span class="nv">$cert</span><span class="p">,</span> <span class="nv">$isPEMFormat</span><span class="p">,</span> <span class="nv">$isURL</span><span class="p">,</span> <span class="nv">$xpath</span><span class="p">);</span>
         <span class="p">}</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-43">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>This function retrieves an associative array of the validated nodes.
 The array will contain the id of the referenced node as the key and the node itself
 as the value.</p>

<p>Returns:
  An associative array of validated nodes or NULL if no nodes have been validated.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getValidatedNodes</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validatedNodes</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">XMLSecEnc</span> <span class="p">{</span>
    <span class="k">const</span> <span class="no">template</span> <span class="o">=</span> <span class="s2">&quot;&lt;xenc:EncryptedData xmlns:xenc=&#39;http://www.w3.org/2001/04/xmlenc#&#39;&gt;</span>
<span class="s2">   &lt;xenc:CipherData&gt;</span>
<span class="s2">      &lt;xenc:CipherValue&gt;&lt;/xenc:CipherValue&gt;</span>
<span class="s2">   &lt;/xenc:CipherData&gt;</span>
<span class="s2">&lt;/xenc:EncryptedData&gt;&quot;</span><span class="p">;</span>

    <span class="k">const</span> <span class="no">Element</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#Element&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">Content</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#Content&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">URI</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">XMLENCNS</span> <span class="o">=</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#&#39;</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$encdoc</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$rawNode</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$type</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$encKey</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$references</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_resetTemplate</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_resetTemplate</span><span class="p">(){</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">loadXML</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">template</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addReference</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$node</span><span class="p">,</span> <span class="nv">$type</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$node</span> <span class="nx">instanceOf</span> <span class="nx">DOMNode</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;$node is not of type DOMNode&#39;</span><span class="p">);</span>
     <span class="p">}</span>
        <span class="nv">$curencdoc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_resetTemplate</span><span class="p">();</span>
        <span class="nv">$encdoc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span> <span class="o">=</span> <span class="nv">$curencdoc</span><span class="p">;</span>
        <span class="nv">$refuri</span> <span class="o">=</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">generate_GUID</span><span class="p">();</span>
        <span class="nv">$element</span> <span class="o">=</span> <span class="nv">$encdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="p">;</span>
        <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s2">&quot;Id&quot;</span><span class="p">,</span> <span class="nv">$refuri</span><span class="p">);</span>
     <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">references</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;node&quot;</span> <span class="o">=&gt;</span> <span class="nv">$node</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span> <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span> <span class="s2">&quot;encnode&quot;</span> <span class="o">=&gt;</span> <span class="nv">$encdoc</span><span class="p">,</span> <span class="s2">&quot;refuri&quot;</span> <span class="o">=&gt;</span> <span class="nv">$refuri</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setNode</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span> <span class="o">=</span> <span class="nv">$node</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">encryptNode</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$replace</span><span class="o">=</span><span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Node to encrypt has not been set&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$objKey</span> <span class="nx">instanceof</span> <span class="nx">XMLSecurityKey</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid Key&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="nv">$xPath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="p">);</span>
        <span class="nv">$objList</span> <span class="o">=</span> <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="s1">&#39;/xenc:EncryptedData/xenc:CipherData/xenc:CipherValue&#39;</span><span class="p">);</span>
        <span class="nv">$cipherValue</span> <span class="o">=</span> <span class="nv">$objList</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$cipherValue</span> <span class="o">==</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Error locating CipherValue element within template&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Element</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">saveXML</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">);</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Element</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Content</span><span class="p">)</span><span class="o">:</span>
                <span class="nv">$children</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">childNodes</span><span class="p">;</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$children</span> <span class="k">AS</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$data</span> <span class="o">.=</span> <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">saveXML</span><span class="p">(</span><span class="nv">$child</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Content</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Type is currently not supported&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$encMethod</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">,</span> <span class="s1">&#39;xenc:EncryptionMethod&#39;</span><span class="p">));</span>
        <span class="nv">$encMethod</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">getAlgorith</span><span class="p">());</span>
        <span class="nv">$cipherValue</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">insertBefore</span><span class="p">(</span><span class="nv">$encMethod</span><span class="p">,</span> <span class="nv">$cipherValue</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">firstChild</span><span class="p">);</span>

        <span class="nv">$strEncrypt</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">encryptData</span><span class="p">(</span><span class="nv">$data</span><span class="p">));</span>
        <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createTextNode</span><span class="p">(</span><span class="nv">$strEncrypt</span><span class="p">);</span>
        <span class="nv">$cipherValue</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$replace</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Element</span><span class="p">)</span><span class="o">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">nodeType</span> <span class="o">==</span> <span class="nx">XML_DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nv">$importEnc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="o">-&gt;</span><span class="na">importNode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">replaceChild</span><span class="p">(</span><span class="nv">$importEnc</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nv">$importEnc</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Content</span><span class="p">)</span><span class="o">:</span>
                    <span class="nv">$importEnc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="o">-&gt;</span><span class="na">importNode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
                    <span class="k">while</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">firstChild</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">removeChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">firstChild</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$importEnc</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nv">$importEnc</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">encryptReferences</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$curRawNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">;</span>
        <span class="nv">$curType</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">references</span> <span class="k">AS</span> <span class="nv">$name</span><span class="o">=&gt;</span><span class="nv">$reference</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span> <span class="o">=</span> <span class="nv">$reference</span><span class="p">[</span><span class="s2">&quot;encnode&quot;</span><span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span> <span class="o">=</span> <span class="nv">$reference</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">];</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">=</span> <span class="nv">$reference</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">];</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nv">$encNode</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encryptNode</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">);</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">references</span><span class="p">[</span><span class="nv">$name</span><span class="p">][</span><span class="s2">&quot;encnode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$encNode</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span> <span class="o">=</span> <span class="nv">$curRawNode</span><span class="p">;</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">=</span> <span class="nv">$curType</span><span class="p">;</span>
                <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span> <span class="o">=</span> <span class="nv">$curRawNode</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span> <span class="o">=</span> <span class="nv">$curType</span><span class="p">;</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-44">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Retrieve the CipherValue text from this encrypted node.</p>

<p><em class='docparam'>@return</em> string|NULL  The Ciphervalue text, or NULL if no CipherValue is found.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCipherValue</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Node to decrypt has not been set&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="nv">$xPath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
        <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;xmlencr&#39;</span><span class="p">,</span> <span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">);</span></pre></div>            </td>
          </tr>
                  <tr id="section-45">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Only handles embedded content right now and not a reference </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./xmlencr:CipherData/xmlencr:CipherValue&quot;</span><span class="p">;</span>
        <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xPath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">);</span>
        <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$node</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nodeValue</span><span class="p">);</span>
    <span class="p">}</span></pre></div>            </td>
          </tr>
                  <tr id="section-46">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Decrypt this encrypted node.</p>

<p>The behaviour of this function depends on the value of $replace.
 If $replace is FALSE, we will return the decrypted data as a string.
 If $replace is TRUE, we will insert the decrypted element(s) into the
 document, and return the decrypted element(s).</p>

<p><em class='docparam'>@params</em> XMLSecurityKey $objKey  The decryption key that should be used when decrypting the node.
<em class='docparam'>@params</em> boolean $replace  Whether we should replace the encrypted node in the XML document with the decrypted data. The default is TRUE.
<em class='docparam'>@return</em> string|DOMElement  The decrypted data.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>     
    <span class="k">public</span> <span class="k">function</span> <span class="nf">decryptNode</span><span class="p">(</span><span class="nv">$objKey</span><span class="p">,</span> <span class="nv">$replace</span><span class="o">=</span><span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$objKey</span> <span class="nx">instanceof</span> <span class="nx">XMLSecurityKey</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid Key&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$encryptedData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getCipherValue</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$encryptedData</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$decrypted</span> <span class="o">=</span> <span class="nv">$objKey</span><span class="o">-&gt;</span><span class="na">decryptData</span><span class="p">(</span><span class="nv">$encryptedData</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$replace</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">type</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Element</span><span class="p">)</span><span class="o">:</span>
                        <span class="nv">$newdoc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
                        <span class="nv">$newdoc</span><span class="o">-&gt;</span><span class="na">loadXML</span><span class="p">(</span><span class="nv">$decrypted</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">nodeType</span> <span class="o">==</span> <span class="nx">XML_DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">return</span> <span class="nv">$newdoc</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nv">$importEnc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="o">-&gt;</span><span class="na">importNode</span><span class="p">(</span><span class="nv">$newdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="o">-&gt;</span><span class="na">replaceChild</span><span class="p">(</span><span class="nv">$importEnc</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nv">$importEnc</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">Content</span><span class="p">)</span><span class="o">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">nodeType</span> <span class="o">==</span> <span class="nx">XML_DOCUMENT_NODE</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nv">$newFrag</span> <span class="o">=</span> <span class="nv">$doc</span><span class="o">-&gt;</span><span class="na">createDocumentFragment</span><span class="p">();</span>
                        <span class="nv">$newFrag</span><span class="o">-&gt;</span><span class="na">appendXML</span><span class="p">(</span><span class="nv">$decrypted</span><span class="p">);</span>
                        <span class="nv">$parent</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="o">-&gt;</span><span class="na">parentNode</span><span class="p">;</span>
                        <span class="nv">$parent</span><span class="o">-&gt;</span><span class="na">replaceChild</span><span class="p">(</span><span class="nv">$newFrag</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nv">$parent</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nv">$decrypted</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$decrypted</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot locate encrypted data&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">encryptKey</span><span class="p">(</span><span class="nv">$srcKey</span><span class="p">,</span> <span class="nv">$rawKey</span><span class="p">,</span> <span class="nv">$append</span><span class="o">=</span><span class="k">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">!</span> <span class="nv">$srcKey</span> <span class="nx">instanceof</span> <span class="nx">XMLSecurityKey</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$rawKey</span> <span class="nx">instanceof</span> <span class="nx">XMLSecurityKey</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid Key&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$strEncKey</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$srcKey</span><span class="o">-&gt;</span><span class="na">encryptData</span><span class="p">(</span><span class="nv">$rawKey</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">));</span>
        <span class="nv">$root</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">documentElement</span><span class="p">;</span>
        <span class="nv">$encKey</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">,</span> <span class="s1">&#39;xenc:EncryptedKey&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$append</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$keyInfo</span> <span class="o">=</span> <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">insertBefore</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#&#39;</span><span class="p">,</span> <span class="s1">&#39;dsig:KeyInfo&#39;</span><span class="p">),</span> <span class="nv">$root</span><span class="o">-&gt;</span><span class="na">firstChild</span><span class="p">);</span>
            <span class="nv">$keyInfo</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$encKey</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encKey</span> <span class="o">=</span> <span class="nv">$encKey</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$encMethod</span> <span class="o">=</span> <span class="nv">$encKey</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">,</span> <span class="s1">&#39;xenc:EncryptionMethod&#39;</span><span class="p">));</span>
        <span class="nv">$encMethod</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">,</span> <span class="nv">$srcKey</span><span class="o">-&gt;</span><span class="na">getAlgorith</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$srcKey</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$keyInfo</span> <span class="o">=</span> <span class="nv">$encKey</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#&#39;</span><span class="p">,</span> <span class="s1">&#39;dsig:KeyInfo&#39;</span><span class="p">));</span>
            <span class="nv">$keyInfo</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="s1">&#39;http://www.w3.org/2000/09/xmldsig#&#39;</span><span class="p">,</span> <span class="s1">&#39;dsig:KeyName&#39;</span><span class="p">,</span> <span class="nv">$srcKey</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="nv">$cipherData</span> <span class="o">=</span> <span class="nv">$encKey</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">,</span> <span class="s1">&#39;xenc:CipherData&#39;</span><span class="p">));</span>
        <span class="nv">$cipherData</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">,</span> <span class="s1">&#39;xenc:CipherValue&#39;</span><span class="p">,</span> <span class="nv">$strEncKey</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">references</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">references</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
           <span class="nv">$refList</span> <span class="o">=</span>  <span class="nv">$encKey</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">,</span> <span class="s1">&#39;xenc:ReferenceList&#39;</span><span class="p">));</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">references</span> <span class="k">AS</span> <span class="nv">$name</span><span class="o">=&gt;</span><span class="nv">$reference</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$refuri</span> <span class="o">=</span> <span class="nv">$reference</span><span class="p">[</span><span class="s2">&quot;refuri&quot;</span><span class="p">];</span>
                <span class="nv">$dataRef</span> <span class="o">=</span> <span class="nv">$refList</span><span class="o">-&gt;</span><span class="na">appendChild</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">encdoc</span><span class="o">-&gt;</span><span class="na">createElementNS</span><span class="p">(</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">,</span> <span class="s1">&#39;xenc:DataReference&#39;</span><span class="p">));</span>
                <span class="nv">$dataRef</span><span class="o">-&gt;</span><span class="na">setAttribute</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="o">.</span> <span class="nv">$refuri</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">decryptKey</span><span class="p">(</span><span class="nv">$encKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$encKey</span><span class="o">-&gt;</span><span class="na">isEncrypted</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Key is not Encrypted&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$encKey</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Key is missing data to perform the decryption&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">decryptNode</span><span class="p">(</span><span class="nv">$encKey</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">locateEncryptedData</span><span class="p">(</span><span class="nv">$element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$element</span> <span class="nx">instanceof</span> <span class="nx">DOMDocument</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$element</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$element</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$doc</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;//*[local-name()=&#39;EncryptedData&#39; and namespace-uri()=&#39;&quot;</span><span class="o">.</span><span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="o">.</span><span class="s2">&quot;&#39;]&quot;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">locateKey</span><span class="p">(</span><span class="nv">$node</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$node</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$node</span> <span class="nx">instanceof</span> <span class="nx">DOMNode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
            <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;xmlsecenc&#39;</span><span class="p">,</span> <span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">);</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;.//xmlsecenc:EncryptionMethod&quot;</span><span class="p">;</span>
            <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$encmeth</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                   <span class="nv">$attrAlgorithm</span> <span class="o">=</span> <span class="nv">$encmeth</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s2">&quot;Algorithm&quot;</span><span class="p">);</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nv">$objKey</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLSecurityKey</span><span class="p">(</span><span class="nv">$attrAlgorithm</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;private&#39;</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nv">$objKey</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">function</span> <span class="nf">staticLocateKeyInfo</span><span class="p">(</span><span class="nv">$objBaseKey</span><span class="o">=</span><span class="k">NULL</span><span class="p">,</span> <span class="nv">$node</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$node</span> <span class="nx">instanceof</span> <span class="nx">DOMNode</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$doc</span> <span class="o">=</span> <span class="nv">$node</span><span class="o">-&gt;</span><span class="na">ownerDocument</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$doc</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$xpath</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMXPath</span><span class="p">(</span><span class="nv">$doc</span><span class="p">);</span>
        <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;xmlsecenc&#39;</span><span class="p">,</span> <span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">XMLENCNS</span><span class="p">);</span>
        <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">registerNamespace</span><span class="p">(</span><span class="s1">&#39;xmlsecdsig&#39;</span><span class="p">,</span> <span class="nx">XMLSecurityDSig</span><span class="o">::</span><span class="na">XMLDSIGNS</span><span class="p">);</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;./xmlsecdsig:KeyInfo&quot;</span><span class="p">;</span>
        <span class="nv">$nodeset</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
        <span class="nv">$encmeth</span> <span class="o">=</span> <span class="nv">$nodeset</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$encmeth</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-47">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>No KeyInfo in EncryptedData / EncryptedKey. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">return</span> <span class="nv">$objBaseKey</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$encmeth</span><span class="o">-&gt;</span><span class="na">childNodes</span> <span class="k">AS</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nv">$child</span><span class="o">-&gt;</span><span class="na">localName</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">&#39;KeyName&#39;</span><span class="o">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$objBaseKey</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nv">$objBaseKey</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$child</span><span class="o">-&gt;</span><span class="na">nodeValue</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;KeyValue&#39;</span><span class="o">:</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$child</span><span class="o">-&gt;</span><span class="na">childNodes</span> <span class="k">AS</span> <span class="nv">$keyval</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">switch</span> <span class="p">(</span><span class="nv">$keyval</span><span class="o">-&gt;</span><span class="na">localName</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">case</span> <span class="s1">&#39;DSAKeyValue&#39;</span><span class="o">:</span>
                                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;DSAKeyValue currently not supported&quot;</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s1">&#39;RSAKeyValue&#39;</span><span class="o">:</span>
                                <span class="nv">$modulus</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
                                <span class="nv">$exponent</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nv">$modulusNode</span> <span class="o">=</span> <span class="nv">$keyval</span><span class="o">-&gt;</span><span class="na">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;Modulus&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="nv">$modulus</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$modulusNode</span><span class="o">-&gt;</span><span class="na">nodeValue</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nv">$exponentNode</span> <span class="o">=</span> <span class="nv">$keyval</span><span class="o">-&gt;</span><span class="na">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;Exponent&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="nv">$exponent</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$exponentNode</span><span class="o">-&gt;</span><span class="na">nodeValue</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$modulus</span><span class="p">)</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$exponent</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Missing Modulus or Exponent&quot;</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="nv">$publicKey</span> <span class="o">=</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">convertRSA</span><span class="p">(</span><span class="nv">$modulus</span><span class="p">,</span> <span class="nv">$exponent</span><span class="p">);</span>
                                <span class="nv">$objBaseKey</span><span class="o">-&gt;</span><span class="na">loadKey</span><span class="p">(</span><span class="nv">$publicKey</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;RetrievalMethod&#39;</span><span class="o">:</span>
                    <span class="nv">$type</span> <span class="o">=</span> <span class="nv">$child</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="o">!==</span> <span class="s1">&#39;http://www.w3.org/2001/04/xmlenc#EncryptedKey&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-48">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Unsupported key type. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nv">$uri</span> <span class="o">=</span> <span class="nv">$child</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;URI&#39;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$uri</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>            </td>
          </tr>
                  <tr id="section-49">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>URI not a reference - unsupported. </p>
            </td>
            <td class="code">
              <div class="highlight"><pre>                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nv">$id</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$uri</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

                    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;//xmlsecenc:EncryptedKey[@Id=&#39;</span><span class="si">$id</span><span class="s2">&#39;]&quot;</span><span class="p">;</span>
                    <span class="nv">$keyElement</span> <span class="o">=</span> <span class="nv">$xpath</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$keyElement</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to locate EncryptedKey with @Id=&#39;</span><span class="si">$id</span><span class="s2">&#39;.&quot;</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">return</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">fromEncryptedKeyElement</span><span class="p">(</span><span class="nv">$keyElement</span><span class="p">);</span>
                <span class="k">case</span> <span class="s1">&#39;EncryptedKey&#39;</span><span class="o">:</span>
                    <span class="k">return</span> <span class="nx">XMLSecurityKey</span><span class="o">::</span><span class="na">fromEncryptedKeyElement</span><span class="p">(</span><span class="nv">$child</span><span class="p">);</span>
                <span class="k">case</span> <span class="s1">&#39;X509Data&#39;</span><span class="o">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$x509certNodes</span> <span class="o">=</span> <span class="nv">$child</span><span class="o">-&gt;</span><span class="na">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;X509Certificate&#39;</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$x509certNodes</span><span class="o">-&gt;</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nv">$x509cert</span> <span class="o">=</span> <span class="nv">$x509certNodes</span><span class="o">-&gt;</span><span class="na">item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">textContent</span><span class="p">;</span>
                            <span class="nv">$x509cert</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$x509cert</span><span class="p">);</span>
                            <span class="nv">$x509cert</span> <span class="o">=</span> <span class="s2">&quot;-----BEGIN CERTIFICATE-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="nb">chunk_split</span><span class="p">(</span><span class="nv">$x509cert</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;-----END CERTIFICATE-----</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
                            <span class="nv">$objBaseKey</span><span class="o">-&gt;</span><span class="na">loadKey</span><span class="p">(</span><span class="nv">$x509cert</span><span class="p">,</span> <span class="k">FALSE</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$objBaseKey</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">locateKeyInfo</span><span class="p">(</span><span class="nv">$objBaseKey</span><span class="o">=</span><span class="k">NULL</span><span class="p">,</span> <span class="nv">$node</span><span class="o">=</span><span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$node</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$node</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">rawNode</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">XMLSecEnc</span><span class="o">::</span><span class="na">staticLocateKeyInfo</span><span class="p">(</span><span class="nv">$objBaseKey</span><span class="p">,</span> <span class="nv">$node</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></pre></div>            </td>
          </tr>
              </tbody>
    </table>
  </div>
</body>
</html>
